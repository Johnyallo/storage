# **Дипломная работа “Облачное хранилище”**  
1. [Описание проекта](#1-Описание-проекта)
2. [Руководство по запуску](#2-Руководство-по-запуску)
---

## 1. Описание проекта
Разработать приложение - REST-сервис. Сервис должен предоставить REST интерфейс для возможности загрузки файлов и вывода списка уже загруженных файлов пользователя. 
Все запросы к сервису должны быть авторизованы. Заранее подготовленное веб-приложение (FRONT) должно подключаться к разработанному сервису без доработок, 
а также использовать функционал FRONT для авторизации, загрузки и вывода списка файлов пользователя.

### Требования к приложению:
- Сервис должен предоставлять REST интерфейс для интеграции с FRONT
- Сервис должны реализовывать все методы описанные CloudServiceSpecification.yaml:
  1. Вывод списка файлов
  2. Добавление файла
  3. Удаление файла
  4. Авторизация
- Все настройки должны вычитываться из файла настроек (yml)
- Информация о пользователях сервиса (логины для авторизации) и данных должны храниться в базе данных (на выбор студента)

### Требования в реализации
- Приложение разработано с использованием Spring Boot
- Использован сборщик пакетов gradle/maven
- Для запуска используется docker, docker-compose
- Код размещен на github
- Код покрыт unit тестами с использованием mockito
- Добавлены интеграционные тесты с использованием testcontainers

### Шаги реализации:
- Изучить протокол получения и отправки сообщений между FRONT и BACKEND
- Нарисовать схему приложений
- Описать архитектуру приложения (где хранятся настройки и хранение больших файлов, структуру таблиц/коллекций базы данных)
- Создать репозиторий проекта на github
- Написать приложение с использованием Spring Boot
- Протестировать приложение с помощью curl/postman
- Протестировать приложение с FRONT
- Написать README.md к проекту
- Отправить на проверку

### Описание и запуск FRONT
1. Установить nodejs (версия не ниже 14.15.0) на компьютер следуя инструкции: https://nodejs.org/ru/download/
2. Скачать [FRONT](./netology-diplom-frontend) (JavaScript)
3. Перейти в папку FRONT приложения и все команды для запуска выполнять из нее.
4. Следуя описанию README.md FRONT проекта запустить nodejs приложение (npm install...)
5. Можно задать url для вызова своего backend сервиса:
    1. В файле `.env` FRONT (находится в корне проекта) приложения нужно изменить url до backend, например: `VUE_APP_BASE_URL=http://localhost:8080`
    2. Пересобрать и запустить FRONT снова: `npm run build`
    3. Измененный `url` сохранится для следующих запусков.
6. По-умолчанию FRONT запускается на порту 8080 и доступен по url в браузере `http://localhost:8080`

### Авторизация приложения:
FRONT приложение использует header `auth-token` в котором отправляет токен (ключ-строка) для идентификации пользователя на BACKEND.
Для получения токена нужно пройти авторизацию на BACKEND и отправить на метод /login пару логин и пароль, в случае успешной проверки в ответ BACKEND должен вернуть json объект
с полем `auth-token` и значением токена. Все дальейшие запросы с FRONTEND, кроме метода /login отправляются с этим header.
Для выхода из приложения нужно вызвать метод BACKEND /logout, который удалит/деактивирует токен и последующие запросы с этим токеном будут не авторизованы и возвращать код 401.

> Для запуска FRONT приложения с расширенным логированием нужно использовать команду: npm run serve


## 2. Руководство по запуску
### Запуск приложения DiplomaWork_cloud_Storage с помощью файла docker-compose.yml (Dockerfile) (frontendApp + backendApp + postgres)
- Клонируем проект на свой ПК [github.com/Johnyallo/diploma.git](https://github.com/Johnyallo/diploma.git);
- Запускаем приложение Docker Desktop;
- Открываем проект в среде разработки IntelliJ IDEA;
- Собрать jar файл можно двумя способами:
  - Запускаем терминал в папке  `/DiplomaWork_cloud_storage` и собираем jar архив с нашим Spring REST приложением с помощью команд:
```mvn clean package -Dskiptests``` и ```mvn clean package -Dmaven.test.skip```;
  - Во вкладке Maven активируем иконку `Togger 'Skip Tests' Mode`, в катлоге `Lifecycle` активировать команды `clear` и `package`;
- После успешной сборки в папке будет находиться jar файл:`DiplomaWork_cloud_storage-0.0.1-SNAPSHOT.jar`;
- В терминале выполнить команду по сборке images и containers: ```docker-compose up```;
- В докере запустятся 3 приложения:
  - backend-server, Java 11 на порту: ```http://localhost:8888```;
  - frontend-client, Node 15 на порту: ```http://localhost:8080```;
  - database-server на порту: ```http://localhost:3306```;
- Запустить тесты можно:
  - Через терминал командой `mvn test`;
  - Во вкладке Maven отключаем иконку `Togger 'Skip Tests' Mode`, в катлоге `Lifecycle` активировать команды `test`;


### Для тестирования frontend + backend + mysql нужно авторизовать пользователя:
 - Отправить POST запрос `http://localhost:8888/login`
 - JSON -> `{
"login": "User",
"password": "user1234"
}` 

### Если в Базе Данных mysql нет этого пользователя, то нужно создать пользователя 
- Отправить POST запрос `http://localhost:8888/user/register`
- JSON -> `{
  "login": "User",
  "password": "user1234"
  }`  

### Завершение работы
- Выход из приложения: в терминале нажать "Ctrl+C"
- Удаление Docker контейнера: ```docker-compose down```


## База данных

В приложении используется СУБД MySQL, со следующими настройками:

`spring.datasource.url=jdbc:mysql://localhost:3306/mysqlDataBase?createDatabaseIfNotExist=true`

`spring.datasource.username=root`

`spring.datasource.password=root`

В программе используется 3 таблицы БД:

* user_entity - для хранения пользователей. Поля id, login, password, role.
* file_entity - для хранения файлов. Поля id, file_name, file_type, file_data, hash, size, user_id
* user_entity_roles - для сопостановления пользователя и ролей. Поля id, roles, user_entity_id.
